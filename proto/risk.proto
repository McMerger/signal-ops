// SignalOps Risk Management Service
// Defines gRPC interface for position tracking, PnL calculation, and risk checks

syntax = "proto3";

package signalops.risk;

option java_multiple_files = true;
option java_package = "io.signalops.risk.proto";
option java_outer_classname = "RiskProto";

import "google/protobuf/timestamp.proto";

// Risk Management Service
service RiskService {
  // Check if a position is within risk limits
  rpc CheckPositionLimit(PositionRequest) returns (RiskCheckResponse);
  
  // Calculate current PnL for a position
  rpc CalculatePnL(PnLRequest) returns (PnLResponse);
  
  // Get current risk metrics
  rpc GetRiskMetrics(RiskMetricsRequest) returns (RiskMetricsResponse);
  
  // Update position after trade execution
  rpc UpdatePosition(PositionUpdate) returns (UpdateResponse);
  
  // Get all open positions
  rpc GetOpenPositions(PositionsRequest) returns (PositionsResponse);
}

// Position limit check request
message PositionRequest {
  string asset = 1;
  string side = 2;  // BUY or SELL
  double quantity = 3;
  double price = 4;
  string account_id = 5;
}

// Risk check response
message RiskCheckResponse {
  bool approved = 1;
  string reason = 2;
  double max_allowed_quantity = 3;
  double current_exposure = 4;
  double exposure_limit = 5;
  google.protobuf.Timestamp timestamp = 6;
}

// PnL calculation request
message PnLRequest {
  string asset = 1;
  string account_id = 2;
  double current_price = 3;
}

// PnL response
message PnLResponse {
  string asset = 1;
  double realized_pnl = 2;
  double unrealized_pnl = 3;
  double total_pnl = 4;
  double average_entry_price = 5;
  double current_position = 6;
  google.protobuf.Timestamp timestamp = 7;
}

// Risk metrics request
message RiskMetricsRequest {
  string account_id = 1;
}

// Risk metrics response
message RiskMetricsResponse {
  double total_exposure = 1;
  double total_pnl = 2;
  double max_drawdown = 3;
  double margin_used = 4;
  double margin_available = 5;
  int32 open_positions_count = 6;
  repeated PositionMetric positions = 7;
  google.protobuf.Timestamp timestamp = 8;
}

message PositionMetric {
  string asset = 1;
  double quantity = 2;
  double average_price = 3;
  double current_price = 4;
  double unrealized_pnl = 5;
  double exposure = 6;
}

// Position update request
message PositionUpdate {
  string asset = 1;
  string side = 2;  // BUY or SELL
  double quantity = 3;
  double price = 4;
  string account_id = 5;
  string order_id = 6;
  google.protobuf.Timestamp executed_at = 7;
}

// Update response
message UpdateResponse {
  bool success = 1;
  string message = 2;
  double new_position = 3;
  double new_average_price = 4;
  google.protobuf.Timestamp timestamp = 5;
}

// Get positions request
message PositionsRequest {
  string account_id = 1;
  string asset = 2;  // Optional: filter by asset
}

// Positions response
message PositionsResponse {
  repeated Position positions = 1;
  google.protobuf.Timestamp timestamp = 2;
}

message Position {
  string asset = 1;
  double quantity = 2;
  double average_price = 3;
  double realized_pnl = 4;
  double unrealized_pnl = 5;
  google.protobuf.Timestamp opened_at = 6;
  google.protobuf.Timestamp updated_at = 7;
}
